/*! Lining.js 2014-10-07 */
!function(a,b){var c,d={STYLE:!0,SCRIPT:!0,LINK:!0,BR:!0},e={TEXTAREA:!0,IMG:!0,INPUT:!0,HR:!0},f={addCSSRule:function(a,d){if(!c){var e=b.createElement("style");e.type="text/css",b.getElementsByTagName("head")[0].appendChild(e),c=b.styleSheets[0]}c.insertRule?c.insertRule(a+"{"+d+"}",c.cssRules?c.cssRules.length:0):c.addRule(a,d,-1)},init:function i(){i.inited||(i.inited=!0,f.addCSSRule("line","display:block;text-indent:0;"),f.addCSSRule("line[first-in-element]:first-child","text-indent:inherit;"))},removeChildren:function(a,b,c){0>b&&(b=0);var d=a.childNodes,e=null==c?d.length:c;if(b>=e)return[];for(var f,g=[],h=e-1;h>=b;)f=d[h],g.push(f),a.removeChild(f),h--;return g},appendChildren:function(a,b){for(;b.length;)a.appendChild(b.pop())},splitNode:function(a,b){var c=a.parentNode,d=a.cloneNode(!1);return f.appendChildren(d,f.removeChildren(a,b)),c.insertBefore(d,a.nextSibling),c},getNodeOffset:function(a,b){for(var c=a,d=0;c=c.previousSibling;)b&&3==c.nodeType?c.nodeType!=c.nextSibling.nodeType&&d++:d++;return d},isEmptyNode:function(a){if(3===a.nodeType)return""===a.nodeValue.trim();var b=a.nodeName;if(d[b])return!0;if(e[b])return!1;var c=a.childNodes;if(!c.length)return!0;for(var g=0,h=c.length;h>g;g++)if(!f.isEmptyNode(c[g]))return!1;return!0},getFirstContentNode:function(a){if(3===a.nodeType)return[a,0];if(e[a.nodeName])return[a.parentNode,f.getNodeOffset(a)];var b=a.firstChild;if(!f.isEmptyNode(b))return f.getFirstContentNode(b);for(var c=b;f.isEmptyNode(b);){if(c=b.nextSibling,!c)return null;b=c}return f.getFirstContentNode(b)},adjustOrSplitNode:function(a,b,c){for(var d,e;b!==a;){switch(d=b.parentNode,e=f.getNodeOffset(b),c){case 0:break;case b.childNodes.length:e++;break;default:f.splitNode(b,c),e++}b=d,c=e}return[b,c]},findContentSibling:function(a,b){var c=0,d=!0;b="forward"===b?"nextSibling":"previousSibling";for(var e=a[b];e;){if(!f.isEmptyNode(e)){d=!1;break}c++,e=e[b]}return[d,c]},isSupported:function(){return Selection&&Selection.prototype&&Selection.prototype.modify},isInLine:function(a,b){for(a=a.parentNode;b.contains(a);){if("LINE"===a.nodeName)return!0;a=a.parentNode}return!1},getAllOutSideBr:function(a){for(var b,c=a.getElementsByTagName("br"),d=[],e=0,g=c.length;g>e;e++)b=c[e],f.isInLine(b,a)||d.push(b);return d}},g=function(a,b){var c=b||{};this.from=c.from-1||parseInt(a.getAttribute("data-from"),10)-1||0,this.from=Math.max(this.from,0),this.to=c.to||parseInt(a.getAttribute("data-to"),10)||null,this._e=a,this._oldWidth=-1,this.doc=null,this.win=null,this._ancestor=null,this._start=null,this._startOffset=0,this._end=null,this._endOffset=0,this._collapsed=!1,this.count=0,this._currentLine=null,this._inited=!1,f.init()};g.prototype.init=function(){if(f.isSupported()){var a=this;if(!a._inited){a._inited=!0,a.doc=a._e.ownerDocument,a.win=a.doc.defaultView,a.relining();var b;return a.win.addEventListener("resize",function(){b&&(clearTimeout(b),b=null),b=setTimeout(function(){a.relining()},1e3)},!1),a}}},g.prototype.dispose=function(){for(var a,b,c,d=this._e.getElementsByTagName("line"),e=0,g=d.length;g>e;e++)for(a=d[e],c=a.parentNode,b=f.removeChildren(a,0);b.length;)c.insertBefore(b.pop(),a);for(;d.length;)a=d[d.length-1],a.parentNode.removeChild(a);for(var h=f.getAllOutSideBr(this._e);h.length;)h.pop().style.display="block";this._e.normalize()},g.prototype.relining=function(){var a=this._e.offsetWidth;if(this._oldWidth>=0){if(this._oldWidth===a)return;this.dispose()}else this._e.normalize();this._currentLine=null,this._oldWidth=a,this.count=this.from;for(var b=this.win.getSelection();this._selectNextLine(b);)this.count<this.from||this._createLine(b);this._currentLine&&(this._currentLine.setAttribute("last",""),this._adjustLine(this._currentLine,b)),b.removeAllRanges();for(var c=f.getAllOutSideBr(this._e);c.length;)c.pop().style.display="none"},g.prototype._update=function(a){this._start=a.startContainer,this._startOffset=a.startOffset,this._end=a.endContainer,this._endOffset=a.endOffset,this._ancestor=a.commonAncestorContainer,this._collapsed=a.collapsed},g.prototype._setCursor=function(a,b,c){var d=c||this.win.getSelection(),e=this.doc.createRange();return e.setStart(a,b),e.collapse(!0),d.removeAllRanges(),d.addRange(e),e},g.prototype.selectLine=function(a){var b=this.win.getSelection();this._setCursor(this._e,0,b),b.modify("extend","forward","character"),b.modify("extend","forward","lineboundary");for(var c,d;a>1;){if(a--,c=b.getRangeAt(0),d=this._getNextLineStartPoint(c.endContainer,c.endOffset),!d)return b.removeAllRanges(),!1;this._setCursor(d[0],d[1],b),b.modify("extend","forward","character"),b.modify("extend","forward","lineboundary")}return this._update(b.getRangeAt(0)),!0},g.prototype._getNextLineStartPoint=function(a,b){var c;if(3===a.nodeType){if(""!==a.nodeValue.slice(b).trim())return[a,b];c=a,b=f.getNodeOffset(a)+1,a=a.parentNode}else c=a.childNodes[b-1];var d=f.findContentSibling(c,"forward"),e=d[0],g=d[1];return e?this._e.contains(a.parentNode)?this._getNextLineStartPoint(a.parentNode,f.getNodeOffset(a)+1):null:(b+=g,f.getFirstContentNode(a.childNodes[b]))},g.prototype._selectNextLine=function(a){if(this.to&&this.count>=this.to)return!1;var b=this._currentLine;if(b){var c=b,d=f.getNodeOffset(c)+1;c=c.parentNode;var e=this._getNextLineStartPoint(c,d);return e&&(this._setCursor(e[0],e[1],a),a.modify("extend","forward","character"),a.modify("extend","forward","lineboundary"),this._update(a.getRangeAt(0))),!!e}return this.selectLine(this.from+1)},g.prototype._getRange=function(){return this.win.getSelection().getRangeAt(0)},g.prototype._adjustLine=function(a,b){var c=this._setCursor(a,0,b);if(b.modify("extend","forward","character"),b.modify("extend","forward","lineboundary"),c=b.getRangeAt(0),this._update(c),a!==this._end&&a.contains(this._end)){this._adjustTextBoundary();var d=f.adjustOrSplitNode(a,this._end,this._endOffset);this._end=d[0],this._endOffset=d[1]}for(var e=f.removeChildren(this._end,this._endOffset),g=this._end.parentNode,h=this._end.nextSibling;e.length;)g.insertBefore(e.pop(),h)},g.prototype._createLine=function(a){var c=b.createElement("line");c.setAttribute("index",++this.count);try{this._getRange().surroundContents(c)}catch(d){this.surroundContents(c)}this._currentLine||c.setAttribute("first",""),this._currentLine=c,(!c.previousSibling||f.findContentSibling(c,"backward")[0])&&c.setAttribute("first-in-element",""),this._adjustLine(c,a)},g.prototype._adjustTextBoundary=function(){3===this._ancestor.nodeType&&(this._ancestor=this._ancestor.parentNode);var a=0,b=this._start,c=this._startOffset,d=b;3===b.nodeType&&(0!==c&&c!==b.nodeValue.length&&(d=b.splitText(c),this._start===this._end&&(a=this._start.nodeValue.length)),this._start=d.parentNode,this._startOffset=f.getNodeOffset(d));var e=a?this._end.nextSibling:this._end,g=this._endOffset-a;3===e.nodeType&&(0!==g&&g!==e.nodeValue.length&&e.splitText(g),this._end=e.parentNode,this._endOffset=f.getNodeOffset(e)+1)},g.prototype._adjustOrSplitNode=function(a){var b,c,d=this._ancestor;a?(b=this._start,c=this._startOffset):(b=this._end,c=this._endOffset);var e=f.adjustOrSplitNode(d,b,c);a?(this._start=e[0],this._startOffset=e[1]):(this._end=e[0],this._endOffset=e[1])},g.prototype.surroundContents=function(a){this._adjustTextBoundary(),this._adjustOrSplitNode(!0),this._adjustOrSplitNode(!1);var b=f.removeChildren(this._ancestor,this._startOffset,this._endOffset);f.appendChildren(a,b);var c=this._startOffset;this._ancestor.insertBefore(a,this._ancestor.childNodes[c])};var h=a.lining=function(a,c){return new g("string"==typeof a?b.getElementById(a):a,c).init()};h.Lining=g,h.util=f,a.addEventListener("load",function(){for(var a,c=b.querySelectorAll("[data-lining]"),d=0,e=c.length;e>d;d++)a=c[d],h(a)},!1)}(window,document);